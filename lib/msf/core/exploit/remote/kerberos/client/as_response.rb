# -*- coding: binary -*-

module Msf
  class Exploit
    class Remote
      module Kerberos
        module Client
          module AsResponse

            # Extracts the session key from a Kerberos AS Response
            #
            # @param res [Rex::Proto::Kerberos::Model::KdcResponse]
            # @param key [String]
            # @return [Rex::Proto::Kerberos::Model::EncryptionKey]
            # @see Rex::Proto::Kerberos::Model::KdcResponse
            # @see Rex::Proto::Kerberos::Model::EncryptedData.decrypt
            # @see Rex::Proto::Kerberos::Model::EncKdcResponse
            # @see Rex::Proto::Kerberos::Model::EncKdcResponse.decode
            # @see Rex::Proto::Kerberos::Model::EncryptionKey
            def extract_session_key(res, key)
              decrypt_res = res.enc_part.decrypt(key, Rex::Proto::Kerberos::Crypto::KeyUsage::TGS_REP_ENCPART_SESSION_KEY)
              enc_kdc_res = Rex::Proto::Kerberos::Model::EncKdcResponse.decode(decrypt_res)

              enc_kdc_res.key
            end

            # Extracts the logon time from a Kerberos AS Response
            #
            # @param res [Rex::Proto::Kerberos::Model::KdcResponse]
            # @param key [String]
            # @return [Integer]
            # @see Rex::Proto::Kerberos::Model::KdcResponse
            # @see Rex::Proto::Kerberos::Model::EncryptedData.decrypt
            # @see Rex::Proto::Kerberos::Model::EncKdcResponse
            # @see Rex::Proto::Kerberos::Model::EncKdcResponse.decode
            def extract_logon_time(res, key)
              decrypt_res = res.enc_part.decrypt(key, Rex::Proto::Kerberos::Crypto::KeyUsage::TGS_REP_ENCPART_SESSION_KEY)
              enc_kdc_res = Rex::Proto::Kerberos::Model::EncKdcResponse.decode(decrypt_res)

              auth_time = enc_kdc_res.auth_time

              auth_time.to_i
            end

            # @param [Rex::Proto::Kerberos::Model::KdcResponse] asrep The krb5 asrep response
            # @return [String] A valid string format which can be cracked offline
            def format_as_rep_to_john_hash(asrep)
              "$krb5asrep$#{asrep.enc_part.etype}$#{asrep.cname.name_string.join('/')}@#{asrep.ticket.realm}:#{asrep.enc_part.cipher[0...16].unpack1('H*')}$#{asrep.enc_part.cipher[16..].unpack1('H*')}"
            end
          end
        end
      end
    end
  end
end
